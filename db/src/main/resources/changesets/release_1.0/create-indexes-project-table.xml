<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                           http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.25.xsd">

    <changeSet id="release-1.0-indexes-project-tables-before" author="vladimir lis">
        <tagDatabase tag="release-1.0-indexes-project-tables-before"/>
    </changeSet>

    <changeSet id="create-indexes-project-members-table" author="vladimir lis">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists tableName="project_members" indexName="IDX_PROJECT_MEMBER_PROJECT_ID"/>
            </not>
            <tableExists tableName="project_members"/>
            <columnExists tableName="project_members" columnName="project_id"/>
        </preConditions>
        <createIndex indexName="IDX_PROJECT_MEMBER_PROJECT_ID" tableName="project_members">
            <column name="project_id"/>
        </createIndex>
        <rollback/>
    </changeSet>

    <changeSet id="create-composite-index-to-project-project-tags-table" author="vladimir lis">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists tableName="project_project_tags" indexName="IDX_PROJECT_PROJECT_TAGS_COMPOSITE"/>
            </not>
            <tableExists tableName="project_project_tags"/>
            <columnExists tableName="project_project_tags" columnName="project_id"/>
            <columnExists tableName="project_project_tags" columnName="project_tag_id"/>
        </preConditions>
        <createIndex indexName="IDX_PROJECT_PROJECT_TAGS_COMPOSITE" tableName="project_project_tags">
            <column name="project_id"/>
            <column name="project_tag_id"/>
        </createIndex>

        <addUniqueConstraint tableName="project_project_tags"
                             columnNames="project_id, project_tag_id"
                             constraintName="UC_PROJECT_PROJECT_TAG"
                             deferrable="false"
                             disabled="false"
                             initiallyDeferred="false"/>
        <rollback/>
    </changeSet>

    <changeSet id="release-1.0-indexes-project-tables-applied" author="vladimir lis">
        <tagDatabase tag="release-1.0-indexes-project-tables-applied"/>
    </changeSet>

</databaseChangeLog>